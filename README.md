# MCP Code Execution

> TypeScript implementation of the code execution pattern from [Anthropic's "Code Execution with MCP"](https://www.anthropic.com/engineering/code-execution-with-mcp) article, reducing token usage by 98.7% through progressive disclosure and local data processing.

## Overview

This project demonstrates how to efficiently integrate multiple MCP (Model Context Protocol) servers by:

- **Loading tools on-demand** instead of upfront (150,000 → 2,000 tokens)
- **Auto-generating TypeScript wrappers** from MCP tool schemas
- **Processing data locally** to keep intermediate results out of context
- **Connecting servers lazily** when tools are first called

## Installation

```bash
git clone https://github.com/yourusername/mcp-code-execution.git
cd mcp-code-execution
npm install
```

## Quick Start

### 1. Configure MCP Servers

Edit `mcp-config.json`:

```json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-filesystem", "/private/tmp"]
    },
    "github": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"]
    }
  }
}
```

### 2. Generate TypeScript Wrappers

```bash
npm run generate
```

This creates typed wrapper functions in `servers/` for all configured MCP tools.

### 3. Use with an LLM

The LLM can now write and execute scripts to complete tasks:

**User Prompt:**
> "Find all TypeScript files in /tmp and count how many contain the word 'async'"

**LLM Response:**
The LLM would:
1. Explore `./servers/` to discover available tools
2. Read the specific tool definitions it needs
3. Write a script using those tools:

```typescript
// Script generated by LLM
import { list_directory, read_text_file } from '../servers/filesystem';

async function main() {
  const files = await list_directory({ path: '/tmp' });
  const tsFiles = files.filter(f => f.endsWith('.ts'));

  let asyncCount = 0;
  for (const file of tsFiles) {
    const content = await read_text_file({ path: `/tmp/${file}` });
    if (content.includes('async')) asyncCount++;
  }

  console.log({
    totalTsFiles: tsFiles.length,
    filesWithAsync: asyncCount
  });
}

main();
```

4. Execute the script: `npm run exec generated-script.ts`
5. Return only the summary to you (not the raw file contents)

## How It Works

### Progressive Disclosure Pattern

Instead of loading all tool definitions upfront, agents discover tools by exploring the filesystem:

```
1. Agent explores ./servers/ directory
2. Reads only needed tool definitions
3. Writes code using selected tools
4. Server connects on first tool call
5. Data processes locally
6. Only summary returns to context
```

**Result:** 98.7% reduction in token usage (150,000 → 2,000 tokens)

### Architecture

```
mcp-code-execution/
├── runtime/
│   ├── mcp-client.ts         # Lazy-loading MCP client manager
│   ├── harness.ts            # Script execution harness
│   └── generate-wrappers.ts  # Auto-generation script
├── servers/                  # Generated wrappers (gitignored)
│   ├── filesystem/
│   │   ├── list_directory.ts
│   │   └── index.ts
│   └── github/
│       ├── search_code.ts
│       └── index.ts
└── tests/                    # Your scripts
```

## Generated Wrappers

The generator creates fully-typed TypeScript interfaces from MCP JSON schemas:

```typescript
// servers/github/search_code.ts (generated)
interface SearchCodeParams {
  q: string;
  order?: 'asc' | 'desc';
  page?: number;
  per_page?: number;
}

export async function search_code(params: SearchCodeParams): Promise<SearchCodeResult> {
  return await callMcpTool<SearchCodeResult>('github__search_code', params);
}
```

## Advanced Usage

### Direct API

Call MCP tools without wrappers:

```typescript
import { callMcpTool } from '../runtime/mcp-client';

const result = await callMcpTool('github__search_code', {
  q: 'language:typescript MCP',
  per_page: 10
});
```

### Adding New Servers

1. Add to `mcp-config.json`:
```json
{
  "mcpServers": {
    "new-server": {
      "command": "npx",
      "args": ["-y", "@your/mcp-server"]
    }
  }
}
```

2. Regenerate wrappers:
```bash
npm run generate
```

3. Use in your scripts:
```typescript
import { some_tool } from '../servers/new-server';
```

## Key Benefits

| Feature | Traditional MCP | Code Execution |
|---------|----------------|----------------|
| Token Usage | 150,000 (all tools loaded) | 2,000 (only what's needed) |
| Server Connections | All at startup | On-demand per tool |
| Data Processing | Through model context | Local execution |
| Type Safety | Manual | Auto-generated |

## Scripts

- `npm run generate` - Generate TypeScript wrappers for all configured servers
- `npm run exec <script>` - Execute a TypeScript script with MCP support

## Examples

- `tests/example-progressive-disclosure.ts` - Demonstrates the progressive disclosure pattern
- `tests/test-generated-wrappers.ts` - Tests auto-generated wrapper functions

## Requirements

- Node.js 18+
- TypeScript 5+
- MCP SDK

## Troubleshooting

| Issue | Solution |
|-------|----------|
| "MCP server not configured" | Check server name in `mcp-config.json` |
| "Connection closed" | Verify MCP server is installed: `npx -y @modelcontextprotocol/server-name --help` |
| Path access denied | On macOS, use `/private/tmp` instead of `/tmp` |
| Missing wrappers | Run `npm run generate` |

## References

- [Code Execution with MCP](https://www.anthropic.com/engineering/code-execution-with-mcp) - Original article by Anthropic
- [Model Context Protocol](https://modelcontextprotocol.io/) - Official MCP documentation
- [MCP Servers](https://github.com/modelcontextprotocol/servers) - Official server implementations

## License

MIT